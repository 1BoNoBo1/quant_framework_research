# üñ•Ô∏è QFrame UI Streamlit Dockerfile

FROM python:3.13-slim

# Variables d'environnement
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    QFRAME_API_URL=http://qframe-api:8000

# Installation des d√©pendances syst√®me
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Installation de Poetry
RUN pip install poetry==1.8.3

# Configuration Poetry
ENV POETRY_NO_INTERACTION=1 \
    POETRY_VENV_IN_PROJECT=1

# Cr√©ation d'un utilisateur non-root
RUN groupadd -r streamlit && useradd -r -g streamlit streamlit

# Cr√©ation des r√©pertoires
WORKDIR /app
RUN mkdir -p /app/logs && chown -R streamlit:streamlit /app

# Copie des fichiers de configuration
COPY pyproject.toml poetry.lock ./

# Installation des d√©pendances
RUN poetry install --only=main --no-root

# Copie du code source
COPY --chown=streamlit:streamlit . .

# Installation du package
RUN poetry run pip install -e .

# Exposition du port Streamlit
EXPOSE 8501

# Health check pour Streamlit
HEALTHCHECK --interval=30s --timeout=30s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Switch vers l'utilisateur non-root
USER streamlit

# Point d'entr√©e Streamlit
CMD ["poetry", "run", "streamlit", "run", "qframe/ui/streamlit_app/main.py", "--server.port=8501", "--server.address=0.0.0.0"]